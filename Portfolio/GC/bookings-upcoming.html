<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Amber ‚Ä¢ Upcoming Bookings</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="bookings.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  </head>
  <body>
    <header class="topbar">
      <button class="menu-toggle" aria-label="Toggle menu" id="menuToggle">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <div class="brand">
        <span class="logo-dot"></span>
        <span class="brand-name">Amber</span>
      </div>

      <form class="search" role="search" action="#">
        <input type="text" placeholder="Search bookings..." aria-label="Search bookings" />
        <button type="submit" aria-label="Search">üîç</button>
      </form>

      <nav class="top-actions" aria-label="Top actions">
        <a href="notifications.html" class="action"><span>üîî</span><span class="label">Notification</span></a>
        <a href="#" class="action"><span>üë§</span><span class="label">Profile</span></a>
      </nav>
    </header>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
    <nav class="mobile-menu" id="mobileMenu" aria-label="Mobile navigation">
      <a class="mobile-nav-item" href="home.html"><span>üè†</span>Home</a>
      <a class="mobile-nav-item" href="activities.html"><span>üéØ</span>Activities</a>
      <a class="mobile-nav-item active" href="bookings-upcoming.html"><span>üìÖ</span>Booking</a>
      <a class="mobile-nav-item" href="location.html"><span>üìç</span>Location</a>
      <a class="mobile-nav-item" href="Settings.html"><span>‚öôÔ∏è</span>Settings</a>
    </nav>

    <div class="layout">
      <aside class="sidebar" aria-label="Main navigation">
        <a class="nav-item" href="home.html"><span>üè†</span>Home</a>
        <a class="nav-item" href="activities.html"><span>üéØ</span>Activities</a>
        <a class="nav-item active" href="bookings-upcoming.html"><span>üìÖ</span>Bookings</a>
        <a class="nav-item" href="location.html"><span>üìç</span>Location</a>
        <a class="nav-item" href="Settings.html"><span>‚öôÔ∏è</span>Settings</a>

        <div class="promos">
          <div class="promo">
            <h4>Weekend Retreat</h4>
            <p>Recharge with 2 days of yoga & breath work.</p>
            <button class="chip">View Retreat</button>
          </div>
          <div class="promo">
            <h4>Weekend Retreat</h4>
            <p>Recharge with 2 days of yoga & breath work.</p>
            <button class="chip ghost">Claim Offer</button>
          </div>
          <div class="promo">
            <h4>Weekend Retreat</h4>
            <p>Recharge with 2 days of yoga & breath work.</p>
            <button class="chip ghost">See Schedule</button>
          </div>
        </div>
      </aside>

      <main class="content bookings">
        <h2 class="section-title">My Bookings</h2>

        <!-- Navigation Tabs -->
        <div class="filter-tabs">
          <a href="bookings-upcoming.html" class="filter-tab active">Upcoming</a>
          <a href="bookings-completed.html" class="filter-tab">Completed</a>
          <a href="bookings-canceled.html" class="filter-tab">Canceled</a>
        </div>

        <!-- Bookings Grid -->
        <div class="bookings-grid">
          <!-- Dynamic bookings from localStorage will be inserted here -->
        </div>

        <!-- Empty State -->
        <div class="empty-state" style="display: none;">
          <div class="empty-icon">üìÖ</div>
          <h3>No upcoming bookings found</h3>
          <p>Try booking a new activity.</p>
          <button class="btn primary" onclick="window.location.href='activities.html'">Browse Activities</button>
        </div>
      </main>
    </div>

    <footer class="footer">
      <div class="footer-content">
        <div class="footer-section">
          <h3>Connect With Us</h3>
          <p>Follow us on social media to get the latest news</p>
          <div class="social-links">
            <a href="https://www.facebook.com/share/17bD2Xt7NX/" class="social-link" target="_blank" rel="noopener noreferrer">
              <img src="https://static.vecteezy.com/system/resources/previews/018/930/698/non_2x/facebook-logo-facebook-icon-transparent-free-png.png" alt="Facebook">
            </a>
            <a href="https://www.instagram.com/amberchamber.ss15?igsh=MTltaGdvaXBpOGVtYQ==" class="social-link" target="_blank" rel="noopener noreferrer">
              <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Instagram_icon.png/1200px-Instagram_icon.png" alt="Instagram">
            </a>
          </div>
          <div class="policy-links">
            <a href="#" class="policy-link">COOKIES POLICY</a>
            <a href="#" class="policy-link">PRIVACY POLICY</a>
            <a href="#" class="policy-link">TERMS AND CONDITIONS</a>
          </div>
        </div>
        
        <div class="footer-section">
          <h3>Explore More</h3>
          <ul class="footer-links">
            <li><a href="#">About Us</a></li>
            <li><a href="#">Founder Message</a></li>
            <li><a href="#">Our Concepts</a></li>
            <li><a href="#">Contact Us</a></li>
          </ul>
        </div>
        
        <div class="footer-section">
          <h3>Our Studios</h3>
          <ul class="footer-links">
            <li><a href="location.html">Our Locations</a></li>
            <li><a href="#">Past Events</a></li>
            <li><a href="#">Opportunities</a></li>
          </ul>
        </div>
      </div>
      
      <div class="footer-bottom">
        <p>Copyright ¬© 2024. Amber Sdn Bhd. All rights reserved</p>
      </div>
    </footer>

    <!-- Cancel Booking Modal -->
    <div class="modal-overlay" id="cancelModal">
      <div class="modal">
        <div class="modal-header">
          <h2>Cancel Booking</h2>
          <button class="close-btn" onclick="closeCancelModal()">&times;</button>
        </div>
        
        <div class="cancel-steps">
          <div class="steps-container">
            <div class="step active" id="step1">
              <div class="step-number">1</div>
              <div class="step-title">Select Booking</div>
            </div>
            <div class="step" id="step2">
              <div class="step-number">2</div>
              <div class="step-title">Provide Reason</div>
            </div>
            <div class="step" id="step3">
              <div class="step-number">3</div>
              <div class="step-title">Confirm Cancellation</div>
            </div>
          </div>
        </div>

        <!-- Cancellation Policy -->
        <div class="cancellation-policy">
          <div class="policy-title">
            <span class="policy-icon">‚ö†Ô∏è</span>
            Cancellation Policy
          </div>
          <div class="policy-content">
            <div class="policy-item">Cancellations made 24+ hours before the session: Full refund</div>
            <div class="policy-item">Cancellations made 2-24 hours before the session: 50% refund</div>
            <div class="policy-item">Cancellations made less than 2 hours before the session: No refund</div>
            <div class="policy-item">Refunds will be processed within 3-5 business days</div>
          </div>
        </div>

        <!-- Booking Selection -->
        <div class="booking-selection" id="bookingSelection">
          <h3>Select a Booking to Cancel</h3>
          <div class="selected-booking" id="selectedBooking">
            <!-- Selected booking details will be populated here -->
          </div>
          <div class="action-buttons">
            <button class="btn secondary" onclick="closeCancelModal()">Cancel</button>
            <button class="btn primary" id="continueBtn" onclick="proceedToReason()">Continue to Reason</button>
          </div>
        </div>

        <!-- Cancellation Form -->
        <div class="cancellation-form" id="cancellationForm" style="display: none;">
          <h3>Why are you cancelling?</h3>
          
          <div class="form-group">
            <label class="form-label">Select a reason for cancellation:</label>
            <div class="form-radio-group" id="reasonGroup">
              <div class="radio-item" onclick="selectReason(this, 'schedule')">
                <input type="radio" name="reason" value="schedule" class="radio-input">
                <label class="radio-label">Schedule conflict</label>
              </div>
              <div class="radio-item" onclick="selectReason(this, 'illness')">
                <input type="radio" name="reason" value="illness" class="radio-input">
                <label class="radio-label">Illness or emergency</label>
              </div>
              <div class="radio-item" onclick="selectReason(this, 'weather')">
                <input type="radio" name="reason" value="weather" class="radio-input">
                <label class="radio-label">Weather conditions</label>
              </div>
              <div class="radio-item" onclick="selectReason(this, 'personal')">
                <input type="radio" name="reason" value="personal" class="radio-input">
                <label class="radio-label">Personal reasons</label>
              </div>
              <div class="radio-item" onclick="selectReason(this, 'other')">
                <input type="radio" name="reason" value="other" class="radio-input">
                <label class="radio-label">Other</label>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Additional comments (optional):</label>
            <textarea class="form-textarea" id="comments" placeholder="Please provide any additional details about your cancellation..."></textarea>
          </div>

          <div class="action-buttons">
            <button class="btn secondary" onclick="goBackToSelection()">Back to Selection</button>
            <button class="btn danger" id="confirmCancelBtn" onclick="showConfirmationModal()">Confirm Cancellation</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmationModal">
      <div class="modal">
        <div class="modal-icon">‚ö†Ô∏è</div>
        <h2 class="modal-title">Confirm Cancellation</h2>
        <p class="modal-message" id="modalMessage">
          Are you sure you want to cancel this booking? This action cannot be undone.
        </p>
        <div class="modal-buttons">
          <button class="btn secondary" onclick="closeConfirmationModal()">Keep Booking</button>
          <button class="btn danger" onclick="processCancellation()">Yes, Cancel Booking</button>
        </div>
      </div>
    </div>

    <!-- View Detail Modal -->
    <div class="modal-overlay" id="viewDetailModal">
      <div class="modal view-detail-modal">
        <div class="modal-header">
          <h2>Booking Details</h2>
          <button class="close-btn" onclick="closeViewDetailModal()">&times;</button>
        </div>
        
        <div class="booking-detail-content" id="bookingDetailContent">
          <!-- Booking details will be populated here -->
        </div>
        
        <div class="modal-buttons">
          <button class="btn secondary" onclick="closeViewDetailModal()">Close</button>
        </div>
      </div>
    </div>

    <script>
      // Load bookings from localStorage and display only upcoming ones
      function loadBookingsFromStorage() {
        try {
          var storedBookings = JSON.parse(localStorage.getItem('userBookings') || '[]');
          var bookingsGrid = document.querySelector('.bookings-grid');
          var emptyState = document.querySelector('.empty-state');
          
          if (!bookingsGrid) {
            console.error('Bookings grid not found in DOM!');
            return;
          }
          
          console.log('Loading upcoming bookings from storage:', storedBookings);
          
          // Clear all existing bookings in the grid
          bookingsGrid.innerHTML = '';
          
          // Filter and add only upcoming bookings (explicitly exclude canceled)
          var upcomingBookings = storedBookings.filter(function(booking) {
            var isUpcoming = booking.status !== 'canceled' && (booking.status === 'upcoming' || !booking.status || booking.status === '');
            if (!isUpcoming) {
              console.log('Filtered out booking:', booking.activity, 'status:', booking.status);
            }
            return isUpcoming;
          });
          
          console.log('Filtered upcoming bookings:', upcomingBookings.length, 'out of', storedBookings.length);
          
          // Add all upcoming bookings to the grid
          upcomingBookings.forEach(function(booking) {
            try {
              var bookingCard = createBookingCard(booking);
              if (bookingCard && bookingsGrid) {
                bookingsGrid.appendChild(bookingCard);
              }
            } catch(e) {
              console.error('Failed to create booking card for:', booking, e);
            }
          });
          
          // Show empty state if no bookings
          if (upcomingBookings.length === 0) {
            emptyState.style.display = 'block';
          } else {
            emptyState.style.display = 'none';
          }
          
          console.log('Added', upcomingBookings.length, 'upcoming bookings to display');
          
        } catch(e) {
          console.error('Failed to load bookings from storage', e);
        }
      }
      
      // Create a booking card element
      function createBookingCard(booking) {
        var card = document.createElement('article');
        card.className = 'booking-card upcoming';
        card.setAttribute('data-status', 'upcoming');
        card.setAttribute('data-dynamic', 'true');
        card.setAttribute('data-booking-id', booking.id);
        
        // Parse date with better error handling
        var dateObj;
        try {
          dateObj = new Date(booking.date);
          // Check if date is valid
          if (isNaN(dateObj.getTime())) {
            console.warn('Invalid date for booking:', booking.date, 'using current date');
            dateObj = new Date();
          }
        } catch(e) {
          console.error('Error parsing date:', booking.date, e);
          dateObj = new Date();
        }
        
        var formattedDate = dateObj.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric', 
          year: 'numeric' 
        });
        
        // Extract day of week and start time
        var dayOfWeek = dateObj.toLocaleDateString('en-US', { weekday: 'short' });
        var timeString = booking.time || '10:00 AM - 11:30 AM';
        var startTime = timeString.split(' - ')[0];
        var timeOnly = startTime.replace(/\s*(AM|PM)/i, '');
        var period = startTime.match(/\s*(AM|PM)/i) ? startTime.match(/\s*(AM|PM)/i)[1] : '';
        var formattedDateTime = dayOfWeek + ' ' + timeOnly.toLowerCase() + period.toLowerCase();
        
        card.innerHTML = `
          <div class="booking-header">
            <div class="booking-status upcoming">
              <span class="status-dot"></span>
              <span class="status-text">Upcoming</span>
            </div>
            <div class="booking-date">${formattedDate}</div>
          </div>
          <div class="booking-content">
            <img src="https://images.unsplash.com/photo-1518617840859-acd0eac7b3fd?q=80&w=1200&auto=format&fit=crop" alt="${booking.activity}" />
            <div class="booking-details">
              <h3>${booking.activity}</h3>
              <div class="booking-meta">
                <div class="meta-item">
                  <span class="meta-icon">üïê</span>
                  <span>${formattedDateTime}</span>
                </div>
                <div class="meta-item">
                  <span class="meta-icon">üë•</span>
                  <span>${booking.numberOfPeople} person${booking.numberOfPeople > 1 ? 's' : ''}</span>
                </div>
                <div class="meta-item">
                  <span class="meta-icon">üí≥</span>
                  <span>Paid via ${booking.paymentMethod}</span>
                </div>
              </div>
              <div class="booking-actions">
                <button class="btn secondary" onclick="openViewDetailModal(${booking.id})">View Detail</button>
                <button class="btn danger" onclick="openCancelModal(this)">Cancel</button>
              </div>
            </div>
          </div>
        `;
        
        return card;
      }
      
      // Initialize page
      document.addEventListener('DOMContentLoaded', function() {
        // Small delay to ensure localStorage is ready after redirect
        setTimeout(function() {
          loadBookingsFromStorage();
        }, 100);
        
        // Search functionality
        const searchInput = document.querySelector('.search input');
        const bookingCards = document.querySelectorAll('.booking-card');
        const emptyState = document.querySelector('.empty-state');
        
        searchInput.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();
          let visibleCount = 0;

          bookingCards.forEach(card => {
            const cardText = card.textContent.toLowerCase();
            if (cardText.includes(searchTerm)) {
              card.style.display = 'block';
              visibleCount++;
            } else {
              card.style.display = 'none';
            }
          });

          if (visibleCount === 0 && searchTerm !== '') {
            emptyState.style.display = 'block';
          } else {
            emptyState.style.display = 'none';
          }
        });

        document.querySelector('.search')?.addEventListener('submit', (e) => e.preventDefault());
        
        // Add click handlers for static booking cards' View Detail buttons
        document.querySelectorAll('.booking-card:not([data-dynamic]) .btn.secondary').forEach(function(button) {
          if (button.textContent.trim() === 'View Detail' || button.textContent.trim() === 'View Details') {
            button.addEventListener('click', function() {
              var bookingCard = this.closest('.booking-card');
              var title = bookingCard.querySelector('h3').textContent;
              var date = bookingCard.querySelector('.booking-date').textContent;
              var metaItems = bookingCard.querySelectorAll('.meta-item');
              
              var parsedDate = new Date(date);
              if (isNaN(parsedDate.getTime())) {
                parsedDate = new Date();
              }
              
              var mockBooking = {
                id: 'static-' + Date.now(),
                activity: title,
                date: parsedDate.toISOString(),
                time: metaItems[0] ? metaItems[0].textContent.replace(/üïê\s*/, '').trim() : '',
                numberOfPeople: 1,
                paymentMethod: 'Credit Card',
                pricePerPerson: '0',
                totalPrice: '0',
                bookingDate: new Date().toISOString(),
                status: 'upcoming',
                bookingFor: 'myself'
              };
              
              openViewDetailModalWithBooking(mockBooking);
            });
          }
        });
      });

      // Cancel Booking Modal Functionality
      let selectedBooking = null;
      let selectedReason = null;

      function openCancelModal(button) {
        const bookingCard = button.closest('.booking-card');
        const bookingTitle = bookingCard.querySelector('h3').textContent;
        const bookingDate = bookingCard.querySelector('.booking-date').textContent;
        const bookingMeta = bookingCard.querySelectorAll('.meta-item');
        const bookingId = bookingCard.getAttribute('data-booking-id');
        const isDynamicBooking = bookingCard.getAttribute('data-dynamic') === 'true';
        
        let time = '';
        let location = '';
        let instructor = '';
        let numberOfPeople = '';
        let paymentMethod = '';
        
        if (isDynamicBooking) {
          time = bookingMeta[0]?.textContent || '';
          numberOfPeople = bookingMeta[1]?.textContent || '';
          paymentMethod = bookingMeta[2]?.textContent || '';
        } else {
          time = bookingMeta[0]?.textContent || '';
          location = bookingMeta[1]?.textContent || '';
          instructor = bookingMeta[2]?.textContent || '';
        }

        selectedBooking = {
          id: bookingId,
          title: bookingTitle,
          date: bookingDate,
          time: time,
          location: location,
          instructor: instructor,
          numberOfPeople: numberOfPeople,
          paymentMethod: paymentMethod,
          isDynamic: isDynamicBooking
        };

        const selectedBookingDiv = document.getElementById('selectedBooking');
        let metaHTML = `
          <div class="meta-item">
            <span class="meta-icon">üìÖ</span>
            <span>${bookingDate}</span>
          </div>
          <div class="meta-item">
            <span class="meta-icon">üïê</span>
            <span>${time}</span>
          </div>
        `;
        
        if (isDynamicBooking) {
          metaHTML += `
            <div class="meta-item">
              <span class="meta-icon">üë•</span>
              <span>${numberOfPeople}</span>
            </div>
            <div class="meta-item">
              <span class="meta-icon">üí≥</span>
              <span>${paymentMethod}</span>
            </div>
          `;
        } else {
          metaHTML += `
            <div class="meta-item">
              <span class="meta-icon">üìç</span>
              <span>${location}</span>
            </div>
            <div class="meta-item">
              <span class="meta-icon">üë§</span>
              <span>${instructor}</span>
            </div>
          `;
        }
        
        selectedBookingDiv.innerHTML = `
          <h4>${bookingTitle}</h4>
          <div class="booking-meta">
            ${metaHTML}
          </div>
        `;

        document.getElementById('cancelModal').classList.add('active');
        resetCancelForm();
      }

      function closeCancelModal() {
        document.getElementById('cancelModal').classList.remove('active');
        selectedBooking = null;
        selectedReason = null;
        resetCancelForm();
      }

      function resetCancelForm() {
        document.getElementById('step1').classList.remove('completed');
        document.getElementById('step1').classList.add('active');
        document.getElementById('step2').classList.remove('active', 'completed');
        document.getElementById('step3').classList.remove('active');

        document.querySelectorAll('.radio-item').forEach(item => {
          item.classList.remove('selected');
        });
        document.querySelectorAll('input[type="radio"]').forEach(radio => {
          radio.checked = false;
        });
        document.getElementById('comments').value = '';

        document.getElementById('bookingSelection').style.display = 'block';
        document.getElementById('cancellationForm').style.display = 'none';
        document.getElementById('continueBtn').disabled = false;
      }

      function proceedToReason() {
        if (!selectedBooking) return;
        
        document.getElementById('step1').classList.add('completed');
        document.getElementById('step2').classList.add('active');
        
        document.getElementById('bookingSelection').style.display = 'none';
        document.getElementById('cancellationForm').style.display = 'block';
      }

      function selectReason(element, reason) {
        document.querySelectorAll('.radio-item').forEach(item => {
          item.classList.remove('selected');
        });
        
        element.classList.add('selected');
        const radioInput = element.querySelector('.radio-input');
        radioInput.checked = true;
        
        selectedReason = reason;
      }

      function goBackToSelection() {
        document.getElementById('step1').classList.remove('completed');
        document.getElementById('step1').classList.add('active');
        document.getElementById('step2').classList.remove('active');
        
        document.getElementById('bookingSelection').style.display = 'block';
        document.getElementById('cancellationForm').style.display = 'none';
      }

      function showConfirmationModal() {
        if (!selectedReason) {
          alert('Please select a reason for cancellation');
          return;
        }
        
        const modal = document.getElementById('confirmationModal');
        const modalMessage = document.getElementById('modalMessage');
        
        const refundAmount = calculateRefund(selectedBooking);
        modalMessage.innerHTML = `
          Are you sure you want to cancel "${selectedBooking.title}"?<br><br>
          <strong>Refund Amount: ${refundAmount}</strong><br>
          This action cannot be undone.
        `;
        
        modal.classList.add('active');
      }

      function calculateRefund(booking) {
        const now = new Date();
        const bookingDate = new Date(now.getTime() + (24 * 60 * 60 * 1000));
        const hoursUntilBooking = (bookingDate - now) / (1000 * 60 * 60);
        
        if (hoursUntilBooking >= 24) {
          return "Full refund";
        } else if (hoursUntilBooking >= 2) {
          return "50% refund";
        } else {
          return "No refund";
        }
      }

      function closeConfirmationModal() {
        document.getElementById('confirmationModal').classList.remove('active');
      }

      function processCancellation() {
        document.getElementById('step2').classList.add('completed');
        document.getElementById('step3').classList.add('active');
        
        closeConfirmationModal();
        
        setTimeout(() => {
          // Update booking status in localStorage
          updateBookingStatusToCanceled(selectedBooking);
          
          // Remove the booking card from the DOM immediately
          if (selectedBooking && selectedBooking.id) {
            var bookingCard = document.querySelector('.booking-card[data-booking-id="' + selectedBooking.id + '"]');
            if (bookingCard) {
              bookingCard.remove();
            }
          }
          
          // Also check for static bookings by title match (for demo bookings)
          if (selectedBooking && selectedBooking.title && !selectedBooking.id) {
            var allCards = document.querySelectorAll('.booking-card');
            allCards.forEach(function(card) {
              var cardTitle = card.querySelector('h3');
              if (cardTitle && cardTitle.textContent.trim() === selectedBooking.title.trim()) {
                card.remove();
              }
            });
          }
          
          // Reload bookings from storage to refresh the list
          loadBookingsFromStorage();
          
          alert('Booking cancelled successfully! You will receive a confirmation email shortly.');
          
          closeCancelModal();
          
        }, 500);
      }
      
      function updateBookingStatusToCanceled(bookingToCancel) {
        try {
          var storedBookings = JSON.parse(localStorage.getItem('userBookings') || '[]');
          
          // Check if this is a dynamic booking (has an ID)
          if (bookingToCancel.id && bookingToCancel.id !== 'null' && bookingToCancel.id !== 'undefined') {
            // Update existing booking status
            var updatedBookings = storedBookings.map(function(booking) {
              if (booking.id == bookingToCancel.id || booking.id == parseInt(bookingToCancel.id)) {
                booking.status = 'canceled';
                booking.canceledDate = new Date().toISOString();
              }
              return booking;
            });
            
            localStorage.setItem('userBookings', JSON.stringify(updatedBookings));
          } else {
            // This is a static booking - create a new entry in localStorage
            var parsedDate = new Date(bookingToCancel.date);
            if (isNaN(parsedDate.getTime())) {
              parsedDate = new Date();
            }
            
            var newCanceledBooking = {
              id: Date.now(), // Generate a unique ID
              activity: bookingToCancel.title,
              date: parsedDate.toISOString(),
              time: bookingToCancel.time || 'TBD',
              numberOfPeople: bookingToCancel.numberOfPeople || '1',
              paymentMethod: bookingToCancel.paymentMethod || 'Credit Card',
              pricePerPerson: '0',
              totalPrice: '0',
              bookingDate: new Date().toISOString(),
              status: 'canceled',
              canceledDate: new Date().toISOString(),
              bookingFor: 'myself'
            };
            
            storedBookings.push(newCanceledBooking);
            localStorage.setItem('userBookings', JSON.stringify(storedBookings));
          }
          
        } catch(e) {
          console.error('Failed to update booking status', e);
        }
      }

      // View Detail Modal functionality
      function openViewDetailModal(bookingId) {
        try {
          var storedBookings = JSON.parse(localStorage.getItem('userBookings') || '[]');
          var booking = storedBookings.find(b => b.id == bookingId);
          
          if (!booking) {
            alert('Booking not found');
            return;
          }
          
          openViewDetailModalWithBooking(booking);
          
        } catch(e) {
          console.error('Failed to open view detail modal', e);
          alert('Failed to load booking details');
        }
      }
      
      function openViewDetailModalWithBooking(booking) {
        try {
          var dateObj = new Date(booking.date);
          var formattedDate = dateObj.toLocaleDateString('en-US', { 
            weekday: 'long',
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          });
          
          var bookingTime = booking.bookingDate ? new Date(booking.bookingDate) : new Date();
          var formattedBookingTime = bookingTime.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          var myselfSection = '';
          if (booking.bookingFor !== 'friend_only') {
            myselfSection = '<div class="detail-section"><h4>üë§ Myself:</h4><ul class="friends-list"><li>You (Main Book)</li></ul></div>';
          }
          
          var friendsList = '';
          if (booking.friends && booking.friends.length > 0) {
            friendsList = '<div class="detail-section"><h4>üë• Friends Booked For:</h4><ul class="friends-list">';
            booking.friends.forEach(function(friend) {
              friendsList += '<li>' + (friend.name || 'Friend') + ' - ' + (friend.email || 'No email provided') + '</li>';
            });
            friendsList += '</ul></div>';
          }
          
          var qrData = JSON.stringify({
            bookingId: booking.id,
            activity: booking.activity,
            date: formattedDate,
            time: booking.time,
            numberOfPeople: booking.numberOfPeople || 1,
            status: booking.status
          });
          
          var detailContent = `
            <div class="booking-detail-info">
              <div class="detail-section">
                <h3>${booking.activity}</h3>
                <div class="detail-item">
                  <span class="detail-label">üìÖ Date:</span>
                  <span class="detail-value">${formattedDate}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">üïê Time:</span>
                  <span class="detail-value">${booking.time}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">üë• Number of People:</span>
                  <span class="detail-value">${booking.numberOfPeople || 1} person${(booking.numberOfPeople || 1) > 1 ? 's' : ''}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">üí≥ Payment Method:</span>
                  <span class="detail-value">${booking.paymentMethod || 'N/A'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">üí∞ Price per Person:</span>
                  <span class="detail-value">RM ${booking.pricePerPerson || '0'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">üíµ Total Amount:</span>
                  <span class="detail-value">RM ${booking.totalPrice || '0'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">üìù Booking Date:</span>
                  <span class="detail-value">${formattedBookingTime}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">üìä Status:</span>
                  <span class="detail-value status-upcoming">Upcoming</span>
                </div>
              </div>
              ${myselfSection}
              ${friendsList}
              <div class="detail-section qr-section">
                <h4>üì± Booking QR Code</h4>
                <div class="qr-container">
                  <div id="qrcode-${booking.id}" class="qrcode"></div>
                  <p class="qr-note">Present this QR code at check-in</p>
                  <button class="btn secondary download-qr-btn" onclick="downloadQRCode('${booking.id}', '${booking.activity.replace(/'/g, "\\'")}')">Download QR Code</button>
                </div>
              </div>
            </div>
          `;
          
          document.getElementById('bookingDetailContent').innerHTML = detailContent;
          document.getElementById('viewDetailModal').classList.add('active');
          
          setTimeout(function() {
            var qrElement = document.getElementById('qrcode-' + booking.id);
            if (qrElement && typeof QRCode !== 'undefined') {
              qrElement.innerHTML = '';
              new QRCode(qrElement, {
                text: qrData,
                width: 200,
                height: 200,
                colorDark: '#1a1a1a',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
              });
            }
          }, 100);
          
        } catch(e) {
          console.error('Failed to open view detail modal', e);
          alert('Failed to load booking details');
        }
      }
      
      function closeViewDetailModal() {
        document.getElementById('viewDetailModal').classList.remove('active');
      }
      
      function downloadQRCode(bookingId, activityName) {
        try {
          var qrContainer = document.getElementById('qrcode-' + bookingId);
          if (!qrContainer) {
            alert('QR code not found');
            return;
          }
          
          var canvas = qrContainer.querySelector('canvas');
          if (!canvas) {
            var img = qrContainer.querySelector('img');
            if (img) {
              canvas = document.createElement('canvas');
              canvas.width = img.width;
              canvas.height = img.height;
              var ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0);
            } else {
              alert('QR code image not found. Please wait a moment and try again.');
              return;
            }
          }
          
          function triggerDownload(imageData) {
            var link = document.createElement('a');
            link.href = imageData;
            link.download = 'Booking_QR_' + activityName.replace(/[^a-z0-9]/gi, '_') + '_' + bookingId + '.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }
          
          if (canvas.toBlob) {
            canvas.toBlob(function(blob) {
              if (!blob) {
                var dataUrl = canvas.toDataURL('image/png');
                triggerDownload(dataUrl);
                return;
              }
              
              var url = URL.createObjectURL(blob);
              triggerDownload(url);
              
              setTimeout(function() {
                URL.revokeObjectURL(url);
              }, 100);
            }, 'image/png');
          } else {
            var dataUrl = canvas.toDataURL('image/png');
            triggerDownload(dataUrl);
          }
          
        } catch(e) {
          console.error('Failed to download QR code', e);
          alert('Failed to download QR code. Please try again.');
        }
      }

      // Close modals when clicking outside
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal-overlay')) {
          if (e.target.id === 'cancelModal') {
            closeCancelModal();
          } else if (e.target.id === 'confirmationModal') {
            closeConfirmationModal();
          } else if (e.target.id === 'viewDetailModal') {
            closeViewDetailModal();
          }
        }
      });

      // Mobile Menu Toggle
      (function(){
        var menuToggle = document.getElementById('menuToggle');
        var mobileMenu = document.getElementById('mobileMenu');
        var mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
        var isOpen = false;

        function openMenu(){
          isOpen = true;
          mobileMenu.classList.add('open');
          mobileMenuOverlay.classList.add('active');
          document.body.style.overflow = 'hidden';
          menuToggle.classList.add('active');
        }

        function closeMenu(){
          isOpen = false;
          mobileMenu.classList.remove('open');
          mobileMenuOverlay.classList.remove('active');
          document.body.style.overflow = '';
          menuToggle.classList.remove('active');
        }

        if(menuToggle){
          menuToggle.addEventListener('click', function(){
            if(isOpen){
              closeMenu();
            } else {
              openMenu();
            }
          });
        }

        if(mobileMenuOverlay){
          mobileMenuOverlay.addEventListener('click', closeMenu);
        }

        if(mobileMenu){
          mobileMenu.querySelectorAll('.mobile-nav-item').forEach(function(item){
            item.addEventListener('click', function(){
              closeMenu();
            });
          });
        }
      })();
    </script>
  </body>
</html>

